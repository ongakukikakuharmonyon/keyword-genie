import streamlit as st
import requests
import pandas as pd
import time
import json
import urllib.parse
from datetime import datetime, timedelta
import re
from concurrent.futures import ThreadPoolExecutor, as_completed

# ãƒšãƒ¼ã‚¸è¨­å®šã‚’æœ€åˆã«é…ç½®
st.set_page_config(
    page_title="SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºæƒ³æ”¯æ´ãƒ„ãƒ¼ãƒ«",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- Googleãƒˆãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ï¼ˆç„¡æ–™ãƒ»è»½é‡ç‰ˆï¼‰ ---
def get_google_trends_data():
    """
    pytrendsãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
    ä¸€èˆ¬çš„ã«ãƒˆãƒ¬ãƒ³ãƒ‰ã«ãªã‚Šã‚„ã™ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿”ã™
    """
    try:
        # pytrends ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è©¦è¡Œ
        from pytrends.request import TrendReq
        
        pytrends = TrendReq(hl='ja-JP', tz=540)  # æ—¥æœ¬èªžã€JST
        
        # æ—¥æœ¬ã®äººæ°—ä¸Šæ˜‡ä¸­ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
        trending_searches = pytrends.trending_searches(pn='japan')
        
        if not trending_searches.empty:
            # ä¸Šä½20ä»¶ã‚’å–å¾—
            trends_list = trending_searches.head(20)[0].tolist()
            return trends_list, True  # å®Ÿéš›ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿
        else:
            return get_trending_keywords_fallback(), False
            
    except ImportError:
        # pytrendsãŒãªã„å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return get_trending_keywords_fallback(), False
    except Exception as e:
        st.warning(f"Googleãƒˆãƒ¬ãƒ³ãƒ‰ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼: {e}")
        return get_trending_keywords_fallback(), False

def get_trending_keywords_fallback():
    """
    pytrendsãŒä½¿ãˆãªã„å ´åˆã®ä»£æ›¿ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    """
    current_year = datetime.now().year
    current_month = datetime.now().month
    
    # å­£ç¯€ãƒ»æ™‚æœŸã«å¿œã˜ãŸãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    seasonal_trends = {
        1: ["æ–°å¹´", "åˆè©£", "ç¦è¢‹", "ãŠã›ã¡", "å¹´å§‹"],
        2: ["ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³", "ç¢ºå®šç”³å‘Š", "èŠ±ç²‰ç—‡", "å—é¨“"],
        3: ["å’æ¥­", "æ–°ç”Ÿæ´»", "å¼•è¶Šã—", "æ¡œ", "æ˜¥"],
        4: ["å…¥å­¦", "æ–°ç¤¾ä¼šäºº", "GW", "èŠ±è¦‹"],
        5: ["æ¯ã®æ—¥", "GW", "æ–°ç·‘", "æ¢…é›¨å¯¾ç­–"],
        6: ["æ¢…é›¨", "çˆ¶ã®æ—¥", "ãƒœãƒ¼ãƒŠã‚¹", "å¤æº–å‚™"],
        7: ["å¤ä¼‘ã¿", "æµ·", "èŠ±ç«", "å¤ç¥­ã‚Š", "ç†±ä¸­ç—‡"],
        8: ["ãŠç›†", "å¸°çœ", "å¤ä¼‘ã¿", "æµ·æ°´æµ´"],
        9: ["ç§‹", "å°é¢¨", "æ–°å­¦æœŸ", "èª­æ›¸"],
        10: ["ãƒãƒ­ã‚¦ã‚£ãƒ³", "ç´…è‘‰", "é£Ÿæ¬²ã®ç§‹", "é‹å‹•ä¼š"],
        11: ["ç´…è‘‰", "ãƒœã‚¸ãƒ§ãƒ¬ãƒ¼", "å¹´æœ«æº–å‚™", "ãƒ–ãƒ©ãƒƒã‚¯ãƒ•ãƒ©ã‚¤ãƒ‡ãƒ¼"],
        12: ["ã‚¯ãƒªã‚¹ãƒžã‚¹", "å¹´æœ«", "å¿˜å¹´ä¼š", "å¤§æŽƒé™¤", "ãŠã›ã¡"]
    }
    
    # ä¸€èˆ¬çš„ãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    general_trends = [
        "AI", "ChatGPT", "å‰¯æ¥­", "æŠ•è³‡", "ç¯€ç´„", "ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ",
        "åœ¨å®…ãƒ¯ãƒ¼ã‚¯", "è»¢è·", "è³‡æ ¼", "è‹±èªžå­¦ç¿’", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°",
        "YouTube", "TikTok", "Instagram", "Twitter", "LINE",
        "iPhone", "Android", "ã‚¢ãƒ—ãƒª", "ã‚²ãƒ¼ãƒ ", "ã‚¢ãƒ‹ãƒ¡"
    ]
    
    # ç¾åœ¨ã®æœˆã®å­£ç¯€ãƒˆãƒ¬ãƒ³ãƒ‰ + ä¸€èˆ¬ãƒˆãƒ¬ãƒ³ãƒ‰
    monthly_trends = seasonal_trends.get(current_month, [])
    
    return monthly_trends + general_trends[:15]

# --- Yahoo!ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ã®ä»£æ›¿æ©Ÿèƒ½ ---
def get_yahoo_realtime_alternative(keyword):
    """
    Yahoo!ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ã®ä»£æ›¿ã¨ã—ã¦ã€Twitter/Xé–¢é€£ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    æ³¨æ„ï¼šç›´æŽ¥çš„ãªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã¯åˆ©ç”¨è¦ç´„é•åã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚‹é–¢é€£èªžç”Ÿæˆã‚’è¡Œã†
    """
    # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã®é«˜ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŽ¥é ­è¾žãƒ»æŽ¥å°¾è¾ž
    realtime_modifiers = [
        "æœ€æ–°", "ä»Š", "ç¾åœ¨", "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ", "é€Ÿå ±", "è©±é¡Œ",
        "ãƒˆãƒ¬ãƒ³ãƒ‰", "äººæ°—", "æ³¨ç›®", "æ€¥ä¸Šæ˜‡", "ãƒã‚º", "ç‚Žä¸Š",
        "2025", "ä»Šå¹´", "ä»Šæœˆ", "ä»Šé€±", "ä»Šæ—¥"
    ]
    
    question_words = [
        "ã¨ã¯", "æ–¹æ³•", "ã‚„ã‚Šæ–¹", "ã‚³ãƒ„", "åŽŸå› ", "ç†ç”±",
        "ã„ã¤", "ã©ã“", "ãªãœ", "ã©ã†ã‚„ã£ã¦", "ã„ãã‚‰"
    ]
    
    realtime_keywords = []
    
    # ä¿®é£¾èªž + ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    for modifier in realtime_modifiers:
        realtime_keywords.append(f"{modifier} {keyword}")
        realtime_keywords.append(f"{keyword} {modifier}")
    
    # ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ + ç–‘å•è©ž
    for question in question_words:
        realtime_keywords.append(f"{keyword} {question}")
    
    return realtime_keywords

# --- ã‚³ã‚¢æ©Ÿèƒ½ï¼šGoogleã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’å–å¾—ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ---
def get_google_suggestions_batch(base_keyword):
    """
    ä¸¦åˆ—å‡¦ç†ã§Googleã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’åŠ¹çŽ‡çš„ã«å–å¾—
    """
    suggest_letters = "abcdefghijklmnopqrstuvwxyzã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“"
    keywords = set([base_keyword])
    errors = []

    url_template = "http://suggestqueries.google.com/complete/search?client=firefox&hl=ja&q={}"
    
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0',
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'ja,en-US;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate',
        'DNT': '1',
        'Connection': 'keep-alive',
        'Upgrade-Insecure-Requests': '1',
    }
    
    search_queries = [base_keyword] + [f"{base_keyword} {letter}" for letter in suggest_letters]

    def fetch_suggestions(query):
        try:
            encoded_query = urllib.parse.quote_plus(query)
            url = url_template.format(encoded_query)
            
            response = requests.get(url, headers=headers, timeout=10)
            response.raise_for_status()
            response.encoding = 'utf-8'
            
            suggestions = json.loads(response.text)
            
            query_keywords = set()
            if len(suggestions) > 1 and suggestions[1]:
                for suggestion in suggestions[1]:
                    if suggestion and len(suggestion.strip()) > 0:
                        query_keywords.add(suggestion.strip())
            
            return query_keywords, None

        except requests.exceptions.RequestException as e:
            return set(), f"ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {query} ({e})"
        except json.JSONDecodeError as e:
            return set(), f"ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æžã‚¨ãƒ©ãƒ¼: {query} ({e})"
        except Exception as e:
            return set(), f"ä¸æ˜Žãªã‚¨ãƒ©ãƒ¼: {query} ({e})"

    # ä¸¦åˆ—å‡¦ç†ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    with ThreadPoolExecutor(max_workers=5) as executor:
        future_to_query = {executor.submit(fetch_suggestions, query): query for query in search_queries}
        
        progress_bar = st.progress(0)
        completed = 0
        
        for future in as_completed(future_to_query):
            result_keywords, error = future.result()
            keywords.update(result_keywords)
            
            if error:
                errors.append(error)
            
            completed += 1
            progress_bar.progress(completed / len(search_queries))
            
            # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
            time.sleep(0.05)
    
    progress_bar.empty()
    
    if errors and len(errors) > len(search_queries) * 0.3:  # ã‚¨ãƒ©ãƒ¼çŽ‡ãŒ30%ã‚’è¶…ãˆã‚‹å ´åˆã®ã¿è¡¨ç¤º
        with st.expander("âš ï¸ å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆè©³ç´°ã‚’è¦‹ã‚‹ï¼‰"):
            st.warning("ä¸€éƒ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Googleã«ã‚ˆã‚‹ä¸€æ™‚çš„ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
            for error in errors[:5]:
                st.text(error)

    return sorted(list(keywords))

# --- ãƒ¡ã‚¤ãƒ³ UI ---
st.title("ðŸš€ SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºæƒ³æ”¯æ´ãƒ„ãƒ¼ãƒ« Pro")
st.markdown("**Googleã‚µã‚¸ã‚§ã‚¹ãƒˆ + ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æž + ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ**")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®è¨­å®š
with st.sidebar:
    st.header("âš™ï¸ æ©Ÿèƒ½è¨­å®š")
    
    enable_trends = st.checkbox("ðŸ”¥ Googleãƒˆãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½", value=True, help="äººæ°—ä¸Šæ˜‡ä¸­ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º")
    enable_realtime = st.checkbox("âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ", value=True, help="æ™‚äº‹æ€§ã®é«˜ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ")
    
    st.header("ðŸ“Š åˆ†æžã‚ªãƒ—ã‚·ãƒ§ãƒ³")
    min_keyword_length = st.slider("æœ€å°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é•·", 1, 10, 2, help="ã“ã®æ–‡å­—æ•°æœªæº€ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é™¤å¤–")
    max_results = st.slider("æœ€å¤§è¡¨ç¤ºä»¶æ•°", 50, 500, 200, help="è¡¨ç¤ºã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸Šé™")

# ã‚¬ã‚¤ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³
guide_tab1, guide_tab2 = st.tabs(["ðŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰", "ðŸŽ¯ SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ”»ç•¥ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«"])

with guide_tab1:
    st.markdown("""
    ### åŸºæœ¬çš„ãªä½¿ã„æ–¹
    1. **ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›**: èª¿æŸ»ã—ãŸã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›
    2. **æ©Ÿèƒ½é¸æŠž**: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ä½¿ç”¨ã—ãŸã„æ©Ÿèƒ½ã‚’é¸æŠž
    3. **åˆ†æžå®Ÿè¡Œ**: ã€Œé–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    4. **çµæžœæ´»ç”¨**: CSVå‡ºåŠ›ã‚„ChatGPTé€£æºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ´»ç”¨
    
    ### æ–°æ©Ÿèƒ½
    - **ðŸ”¥ Googleãƒˆãƒ¬ãƒ³ãƒ‰**: ç¾åœ¨äººæ°—ä¸Šæ˜‡ä¸­ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    - **âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”Ÿæˆ**: æ™‚äº‹æ€§ã®é«˜ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆ
    - **ðŸš€ ä¸¦åˆ—å‡¦ç†**: ã‚ˆã‚Šé«˜é€Ÿãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å–å¾—
    
    ### æ´»ç”¨ã®ã‚³ãƒ„
    - è¤‡æ•°ã®æ©Ÿèƒ½ã‚’çµ„ã¿åˆã‚ã›ã¦åŒ…æ‹¬çš„ãªåˆ†æžã‚’å®Ÿè¡Œ
    - ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ–°ã—ã„åˆ‡ã‚Šå£ã‚’ç™ºè¦‹
    - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æœ€æ–°ã®æ¤œç´¢éœ€è¦ã‚’ã‚­ãƒ£ãƒƒãƒ
    """)

with guide_tab2:
    st.markdown("""
    # ðŸŽ¯ SEOã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ”»ç•¥ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«
    
    ## ðŸš« ã‚ˆãã‚ã‚‹å¤±æ•—ä¾‹
    
    ### âŒ æŠ½è±¡çš„ã™ãŽã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    ```
    ã€Œã‚¯ãƒ©ã‚·ãƒƒã‚¯éŸ³æ¥½ æ¼”å¥ åŠ¹æžœã€
    â†’ çµæžœï¼šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åã‚„æ¥½å™¨åã°ã‹ã‚Š
    ```
    
    ### âŒ åºƒã™ãŽã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    ```
    ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆã€ã€Œå‰¯æ¥­ã€ã€ŒæŠ•è³‡ã€
    â†’ çµæžœï¼šç«¶åˆãŒå¼·ã™ãŽã¦ä¸Šä½è¡¨ç¤ºå›°é›£
    ```
    
    ## âœ… åŠ¹æžœçš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æˆ¦ç•¥
    
    ### 1. ðŸŽ¯ æ¤œç´¢æ„å›³ã‚’æ˜Žç¢ºã«ã™ã‚‹
    
    | âŒ æŠ½è±¡çš„ | âœ… å…·ä½“çš„ |
    |----------|----------|
    | `éŸ³æ¥½ åŠ¹æžœ` | `ã‚¯ãƒ©ã‚·ãƒƒã‚¯éŸ³æ¥½ é›†ä¸­åŠ› å‘ä¸Š` |
    | `ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ æ–¹æ³•` | `30ä»£ å¥³æ€§ ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ é‹å‹•ãªã—` |
    | `å‰¯æ¥­ ãŠã™ã™ã‚` | `åœ¨å®… å‰¯æ¥­ æœˆ5ä¸‡ åˆå¿ƒè€…` |
    
    ### 2. ðŸ” 4ã¤ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—
    
    #### ðŸ”Ž **Knowã‚¯ã‚¨ãƒªï¼ˆçŸ¥ã‚ŠãŸã„ï¼‰**
    - `â—‹â—‹ ã¨ã¯`
    - `â—‹â—‹ æ„å‘³`
    - `â—‹â—‹ ä»•çµ„ã¿`
    - `â—‹â—‹ åŠ¹æžœ`
    
    #### ðŸƒ **Doã‚¯ã‚¨ãƒªï¼ˆã‚„ã‚ŠãŸã„ï¼‰**
    - `â—‹â—‹ æ–¹æ³•`
    - `â—‹â—‹ ã‚„ã‚Šæ–¹`
    - `â—‹â—‹ æ‰‹é †`
    - `â—‹â—‹ ã‚³ãƒ„`
    
    #### ðŸš¶ **Goã‚¯ã‚¨ãƒªï¼ˆè¡ŒããŸã„ï¼‰**
    - `â—‹â—‹ åº—èˆ—`
    - `â—‹â—‹ å ´æ‰€`
    - `â—‹â—‹ ã‚¢ã‚¯ã‚»ã‚¹`
    
    #### ðŸ’° **Buyã‚¯ã‚¨ãƒªï¼ˆè²·ã„ãŸã„ï¼‰**
    - `â—‹â—‹ ãŠã™ã™ã‚`
    - `â—‹â—‹ æ¯”è¼ƒ`
    - `â—‹â—‹ å£ã‚³ãƒŸ`
    - `â—‹â—‹ æœ€å®‰å€¤`
    
    ### 3. ðŸ“Š æ®µéšŽçš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±•é–‹æ³•
    
    #### Step1: ðŸŒ± ã‚·ãƒ¼ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    ```
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€
    ```
    
    #### Step2: ðŸŒ¿ ã‚«ãƒ†ã‚´ãƒªå±•é–‹
    ```
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° å­¦ç¿’ã€
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° è¨€èªžã€
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° ä»•äº‹ã€
    ```
    
    #### Step3: ðŸŒ³ å…·ä½“åŒ–
    ```
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° å­¦ç¿’ ç‹¬å­¦ã€
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° è¨€èªž åˆå¿ƒè€…ã€
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° ä»•äº‹ æœªçµŒé¨“ã€
    ```
    
    #### Step4: ðŸŽ¯ è¶…å…·ä½“åŒ–
    ```
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° ç‹¬å­¦ 30ä»£ æœªçµŒé¨“ã€
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° è¨€èªž é¸ã³æ–¹ 2024ã€
    ã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° è»¢è· æˆåŠŸ ä½“é¨“è«‡ã€
    ```
    
    ## ðŸ’¡ å®Ÿè·µçš„ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
    
    ### A. ç–‘å•ç³»ãƒ‘ã‚¿ãƒ¼ãƒ³
    ```
    âœ… ã€Œâ—‹â—‹ ãªãœã€
    âœ… ã€Œâ—‹â—‹ ã©ã†ã‚„ã£ã¦ã€
    âœ… ã€Œâ—‹â—‹ ã„ã¤ã€
    âœ… ã€Œâ—‹â—‹ ã©ã“ã§ã€
    âœ… ã€Œâ—‹â—‹ ã„ãã‚‰ã€
    ```
    
    ### B. æ„Ÿæƒ…ãƒ»çŠ¶æ…‹ãƒ‘ã‚¿ãƒ¼ãƒ³
    ```
    âœ… ã€Œâ—‹â—‹ æ‚©ã¿ã€
    âœ… ã€Œâ—‹â—‹ å›°ã£ãŸã€
    âœ… ã€Œâ—‹â—‹ å¤±æ•—ã€
    âœ… ã€Œâ—‹â—‹ æˆåŠŸã€
    âœ… ã€Œâ—‹â—‹ ä¸å®‰ã€
    ```
    
    ### C. å±žæ€§çµ„ã¿åˆã‚ã›ãƒ‘ã‚¿ãƒ¼ãƒ³
    ```
    âœ… ã€Œâ—‹â—‹ åˆå¿ƒè€…ã€
    âœ… ã€Œâ—‹â—‹ 30ä»£ã€
    âœ… ã€Œâ—‹â—‹ å¥³æ€§ã€
    âœ… ã€Œâ—‹â—‹ ä¸»å©¦ã€
    âœ… ã€Œâ—‹â—‹ å­¦ç”Ÿã€
    ```
    
    ### D. æ™‚æœŸãƒ»æœŸé–“ãƒ‘ã‚¿ãƒ¼ãƒ³
    ```
    âœ… ã€Œâ—‹â—‹ çŸ­æœŸé–“ã€
    âœ… ã€Œâ—‹â—‹ 1ãƒ¶æœˆã€
    âœ… ã€Œâ—‹â—‹ å³åŠ¹æ€§ã€
    âœ… ã€Œâ—‹â—‹ ç¶™ç¶šã€
    ```
    
    ## ðŸ”¥ é«˜ä¾¡å€¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹æ³•
    
    ### 1. ðŸŽ¯ ãƒ­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç‹™ã„
    ```
    âŒ ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆã€ï¼ˆæ¤œç´¢æ•°ï¼š100ä¸‡ã€ç«¶åˆï¼šæ¿€é«˜ï¼‰
    âœ… ã€Œç”£å¾Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆ æ¯ä¹³ å½±éŸ¿ãªã—ã€ï¼ˆæ¤œç´¢æ•°ï¼š1ä¸‡ã€ç«¶åˆï¼šä¸­ï¼‰
    ```
    
    ### 2. ðŸ” é–¢é€£èªžã®æ·±æŽ˜ã‚Š
    ```
    ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼šã€Œè‹±èªžå­¦ç¿’ã€
    â†“
    ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼šã€Œè‹±èªžå­¦ç¿’ ã‚¢ãƒ—ãƒªã€
    â†“
    æ·±æŽ˜ã‚Šï¼šã€Œè‹±èªžå­¦ç¿’ ã‚¢ãƒ—ãƒª ç„¡æ–™ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€
    ```
    
    ### 3. ðŸŽª å­£ç¯€ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰æ´»ç”¨
    ```
    åŸºæœ¬ï¼šã€Œè»¢è·ã€
    â†“
    å­£ç¯€æ€§ï¼šã€Œè»¢è· 4æœˆå…¥ç¤¾ æº–å‚™ã€
    ãƒˆãƒ¬ãƒ³ãƒ‰ï¼šã€Œè»¢è· ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ æ±‚äººã€
    ```
    
    ## ðŸš€ ã“ã®ãƒ„ãƒ¼ãƒ«ã§ã®å®Ÿè·µæ–¹æ³•
    
    ### 1. æ®µéšŽçš„å±•é–‹ã§ä½¿ã†
    ```
    1å›žç›®ï¼šã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ã§åŸºæœ¬ã‚µã‚¸ã‚§ã‚¹ãƒˆå–å¾—
    2å›žç›®ï¼šã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° å­¦ç¿’ã€ã§å­¦ç¿’ç³»ã‚’æ·±æŽ˜ã‚Š
    3å›žç›®ï¼šã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° å­¦ç¿’ ç‹¬å­¦ã€ã§ã•ã‚‰ã«å…·ä½“åŒ–
    ```
    
    ### 2. è¤‡æ•°è§’åº¦ã‹ã‚‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
    ```
    - ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆ æ–¹æ³•ã€ï¼ˆHowç³»ï¼‰
    - ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆ åŠ¹æžœã€ï¼ˆWhyç³»ï¼‰
    - ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆ ãŠã™ã™ã‚ã€ï¼ˆWhatç³»ï¼‰
    - ã€Œãƒ€ã‚¤ã‚¨ãƒƒãƒˆ å¤±æ•—ã€ï¼ˆå•é¡Œç³»ï¼‰
    ```
    
    ### 3. ç«¶åˆåˆ†æžä½µç”¨
    ```
    1. ãƒ„ãƒ¼ãƒ«ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åŽé›†
    2. Googleæ¤œç´¢ã§ä¸Šä½ã‚µã‚¤ãƒˆç¢ºèª
    3. ä¸Šä½ã‚µã‚¤ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è¦‹å‡ºã—åˆ†æž
    4. æ–°ãŸãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¦‹
    ```
    
    ## ðŸ“ˆ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¾¡å€¤åˆ¤å®šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
    
    ### âœ… é«˜ä¾¡å€¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç‰¹å¾´
    - [ ] å…·ä½“çš„ãªæ‚©ã¿ãƒ»å•é¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹
    - [ ] ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜Žç¢º
    - [ ] è§£æ±ºç­–ã‚’æ±‚ã‚ã‚‹æ„å›³ãŒå¼·ã„
    - [ ] ç«¶åˆãŒä¸­ç¨‹åº¦ï¼ˆæ¿€æˆ¦ã§ã¯ãªã„ï¼‰
    - [ ] å•†ç”¨åˆ©ç”¨ã®å¯èƒ½æ€§ãŒã‚ã‚‹
    
    ### âŒ ä½Žä¾¡å€¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç‰¹å¾´
    - [ ] ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åã®ã¿ï¼ˆYouTubeã€Amazonãªã©ï¼‰
    - [ ] å˜ç´”ãªå›ºæœ‰åè©ž
    - [ ] æ¤œç´¢æ„å›³ãŒä¸æ˜Ž
    - [ ] ç«¶åˆãŒæ¿€ã—ã™ãŽã‚‹
    - [ ] æ¤œç´¢ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæ¥µç«¯ã«å°‘ãªã„
    
    ## ðŸŽ¯ æ¥­ç•Œåˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æˆ¦ç•¥ä¾‹
    
    ### ðŸ¥ å¥åº·ãƒ»åŒ»ç™‚ç³»
    ```
    åŸºæœ¬ï¼šã€Œé ­ç—› æ²»ã—æ–¹ã€
    æ·±æŽ˜ã‚Šï¼šã€Œé ­ç—› æ²»ã—æ–¹ å³åŠ¹æ€§ è–¬ãªã—ã€
    ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼šã€Œé ­ç—› æ²»ã—æ–¹ å¦Šå©¦ å®‰å…¨ã€
    ```
    
    ### ðŸ’° é‡‘èžãƒ»æŠ•è³‡ç³»
    ```
    åŸºæœ¬ï¼šã€Œæ ªå¼æŠ•è³‡ å§‹ã‚æ–¹ã€
    æ·±æŽ˜ã‚Šï¼šã€Œæ ªå¼æŠ•è³‡ å§‹ã‚æ–¹ å°‘é¡ åˆå¿ƒè€…ã€
    ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼šã€Œæ ªå¼æŠ•è³‡ å§‹ã‚æ–¹ ä¸»å©¦ NISAã€
    ```
    
    ### ðŸ“š æ•™è‚²ãƒ»ã‚¹ã‚­ãƒ«ç³»
    ```
    åŸºæœ¬ï¼šã€Œè‹±èªž å‹‰å¼·æ³•ã€
    æ·±æŽ˜ã‚Šï¼šã€Œè‹±èªž å‹‰å¼·æ³• ç¤¾ä¼šäºº ç‹¬å­¦ã€
    ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼šã€Œè‹±èªž å‹‰å¼·æ³• TOEIC600 3ãƒ¶æœˆã€
    ```
    
    ---
    
    ðŸ’¡ **ã“ã®ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’å‚è€ƒã«ã€æˆ¦ç•¥çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­è¨ˆã‚’ã—ã¦ã¿ã¦ãã ã•ã„ï¼**
    """)
    
    # å®Ÿè·µä¾‹ã®è¡¨ç¤º
    st.success("ðŸ’¡ **å®Ÿè·µã®ã‚³ãƒ„**: ä¸Šè¨˜ã®æˆ¦ç•¥ã‚’ä½¿ã£ã¦ã€ã“ã®ãƒ„ãƒ¼ãƒ«ã§æ®µéšŽçš„ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ·±æŽ˜ã‚Šã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼")

# ãƒ¡ã‚¤ãƒ³ã®å…¥åŠ›ã‚¨ãƒªã‚¢
col1, col2 = st.columns([3, 1])

with col1:
    keyword_input = st.text_input(
        "ðŸŽ¯ ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›",
        placeholder="ä¾‹ï¼šå‰¯æ¥­ ãƒ–ãƒ­ã‚°",
        help="ã“ã“ã«å…¥åŠ›ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¤§é‡ã«å–å¾—ã—ã¾ã™ã€‚"
    )

with col2:
    st.write("")  # ã‚¹ãƒšãƒ¼ã‚¹èª¿æ•´
    st.write("")  # ã‚¹ãƒšãƒ¼ã‚¹èª¿æ•´
    analyze_button = st.button("ðŸ” åˆ†æžé–‹å§‹", type="primary", use_container_width=True)

# Googleãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã§æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
if enable_trends:
    with st.container():
        st.subheader("ðŸ”¥ ç¾åœ¨ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰")
        
        trends_col1, trends_col2 = st.columns([2, 1])
        
        with trends_col1:
            if st.button("ðŸ”„ ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å–å¾—", key="get_trends"):
                with st.spinner("ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ä¸­..."):
                    trending_keywords, is_real_trend = get_google_trends_data()
                
                if trending_keywords:
                    if is_real_trend:
                        st.success(f"âœ… Googleãƒˆãƒ¬ãƒ³ãƒ‰ã‹ã‚‰{len(trending_keywords)}ä»¶å–å¾—")
                    else:
                        st.info(f"ðŸ’¡ å­£ç¯€ãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰äºˆæ¸¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰{len(trending_keywords)}ä»¶ã‚’è¡¨ç¤º")
                        st.caption("ðŸ’¡ å®Ÿéš›ã®Googleãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ `pip install pytrends` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„")
                    
                    # ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚«ãƒ©ãƒ ã§è¡¨ç¤º
                    trend_cols = st.columns(4)
                    for i, trend in enumerate(trending_keywords):
                        with trend_cols[i % 4]:
                            if st.button(f"ðŸ“ˆ {trend}", key=f"trend_{i}", help="ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«è¨­å®š"):
                                st.session_state.trend_selected = trend
                                st.rerun()
                else:
                    st.info("ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
        
        with trends_col2:
            st.info("ðŸ’¡ **Tip**: ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™")

# ãƒˆãƒ¬ãƒ³ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒé¸æŠžã•ã‚ŒãŸå ´åˆã®å‡¦ç†
if 'trend_selected' in st.session_state:
    keyword_input = st.session_state.trend_selected
    del st.session_state.trend_selected

# ãƒ¡ã‚¤ãƒ³åˆ†æžå‡¦ç†
if analyze_button and keyword_input:
    all_keywords = set()
    
    # 1. Googleã‚µã‚¸ã‚§ã‚¹ãƒˆå–å¾—
    st.subheader("ðŸ“‹ åˆ†æžçµæžœ")
    
    with st.spinner("ðŸ” Googleã‚µã‚¸ã‚§ã‚¹ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ä¸­..."):
        suggestions_list = get_google_suggestions_batch(keyword_input)
        all_keywords.update(suggestions_list)
    
    suggestion_count = len(suggestions_list)
    st.success(f"âœ… Googleã‚µã‚¸ã‚§ã‚¹ãƒˆ: **{suggestion_count}ä»¶** ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—")
    
    # 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
    if enable_realtime:
        with st.spinner("âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆä¸­..."):
            realtime_keywords = get_yahoo_realtime_alternative(keyword_input)
            all_keywords.update(realtime_keywords)
        
        realtime_count = len(realtime_keywords)
        st.success(f"âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”Ÿæˆ: **{realtime_count}ä»¶** ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ")
    
    # 3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨æ•´ç†
    filtered_keywords = []
    for kw in all_keywords:
        if len(kw) >= min_keyword_length and kw.strip():
            filtered_keywords.append(kw.strip())
    
    # é‡è¤‡é™¤åŽ»ã¨ä¸¦ã³æ›¿ãˆ
    filtered_keywords = sorted(list(set(filtered_keywords)))
    
    # æœ€å¤§ä»¶æ•°åˆ¶é™
    if len(filtered_keywords) > max_results:
        filtered_keywords = filtered_keywords[:max_results]
        st.warning(f"âš ï¸ çµæžœãŒ{max_results}ä»¶ã«åˆ¶é™ã•ã‚Œã¾ã—ãŸã€‚ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ä¸Šé™ã‚’èª¿æ•´ã§ãã¾ã™ã€‚")
    
    total_count = len(filtered_keywords)
    
    if total_count > 0:
        st.success(f"ðŸŽ‰ **åˆè¨ˆ {total_count}ä»¶** ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ãƒ»ç”Ÿæˆã—ã¾ã—ãŸï¼")
        
        # ã‚¿ãƒ–ã§çµæžœã‚’åˆ†é¡žè¡¨ç¤º
        tab1, tab2, tab3 = st.tabs(["ðŸ“Š å…¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§", "ðŸ“¥ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›", "ðŸ¤– ChatGPTé€£æº"])
        
        with tab1:
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã§è¡¨ç¤º
            df = pd.DataFrame(filtered_keywords, columns=["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"])
            df["æ–‡å­—æ•°"] = df["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"].str.len()
            df["ç¨®åˆ¥"] = df["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"].apply(
                lambda x: "ãƒˆãƒ¬ãƒ³ãƒ‰ç³»" if any(word in x for word in ["æœ€æ–°", "ä»Š", "ç¾åœ¨", "è©±é¡Œ", "é€Ÿå ±"]) 
                else "ç–‘å•ç³»" if any(word in x for word in ["ã¨ã¯", "æ–¹æ³•", "ã‚„ã‚Šæ–¹", "ãªãœ"]) 
                else "ä¸€èˆ¬"
            )
            
            # ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
            col1, col2, col3 = st.columns(3)
            with col1:
                filter_type = st.selectbox("ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿", ["å…¨ã¦", "ä¸€èˆ¬", "ç–‘å•ç³»", "ãƒˆãƒ¬ãƒ³ãƒ‰ç³»"])
            with col2:
                min_chars = st.number_input("æœ€å°æ–‡å­—æ•°", min_value=1, value=1)
            with col3:
                max_chars = st.number_input("æœ€å¤§æ–‡å­—æ•°", min_value=1, value=50)
            
            # ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
            filtered_df = df.copy()
            if filter_type != "å…¨ã¦":
                filtered_df = filtered_df[filtered_df["ç¨®åˆ¥"] == filter_type]
            filtered_df = filtered_df[
                (filtered_df["æ–‡å­—æ•°"] >= min_chars) & 
                (filtered_df["æ–‡å­—æ•°"] <= max_chars)
            ]
            
            st.dataframe(
                filtered_df,
                height=400,
                use_container_width=True,
                column_config={
                    "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰": st.column_config.TextColumn("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰", width="large"),
                    "æ–‡å­—æ•°": st.column_config.NumberColumn("æ–‡å­—æ•°", width="small"),
                    "ç¨®åˆ¥": st.column_config.TextColumn("ç¨®åˆ¥", width="medium")
                }
            )
        
        with tab2:
            st.subheader("ðŸ“¥ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›")
            
            # CSVå‡ºåŠ›
            csv = df.to_csv(index=False).encode('utf-8-sig')
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            
            col1, col2 = st.columns(2)
            with col1:
                st.download_button(
                    label="ðŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=csv,
                    file_name=f"{keyword_input}_keywords_{timestamp}.csv",
                    mime="text/csv",
                    use_container_width=True
                )
            
            with col2:
                # JSONå½¢å¼ã§ã®å‡ºåŠ›
                json_data = {
                    "base_keyword": keyword_input,
                    "timestamp": timestamp,
                    "total_count": total_count,
                    "keywords": filtered_keywords
                }
                json_str = json.dumps(json_data, ensure_ascii=False, indent=2)
                
                st.download_button(
                    label="ðŸ“¥ JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=json_str.encode('utf-8'),
                    file_name=f"{keyword_input}_keywords_{timestamp}.json",
                    mime="application/json",
                    use_container_width=True
                )
        
        with tab3:
            st.subheader("ðŸ¤– ChatGPTé€£æºãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ")
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é¸æŠž
            prompt_type = st.selectbox(
                "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠž",
                ["è¨˜äº‹ä¼ç”»ç”Ÿæˆ", "SEOè¨˜äº‹æ§‹æˆ", "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¤ãƒ‡ã‚¢", "ç«¶åˆåˆ†æž"]
            )
            
            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’æ•´å½¢
            formatted_keywords = "\n".join([f"- {kw}" for kw in filtered_keywords[:50]])  # ä¸Šä½50ä»¶ã®ã¿
            
            # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            prompts = {
                "è¨˜äº‹ä¼ç”»ç”Ÿæˆ": f"""ã‚ãªãŸã¯å„ªç§€ãªWebãƒ¡ãƒ‡ã‚£ã‚¢ã®ç·¨é›†é•·ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰èª­è€…ã®æ¤œç´¢æ„å›³ã‚’æ·±ãèª­ã¿å–ã‚Šã€æ¤œç´¢ä¸Šä½ã‚’ç‹™ãˆã‚‹é«˜å“è³ªãªãƒ–ãƒ­ã‚°è¨˜äº‹ã®ä¼ç”»ã‚’5ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚

å„ææ¡ˆã¯ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

---
â—† ä¼ç”»æ¡ˆ {{ç•ªå·}}
ã€ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆã€‘ï¼šï¼ˆã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚„ã™ã„ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
ã€æƒ³å®šèª­è€…ã€‘ï¼šï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‚©ã¿ãƒ»å±žæ€§ï¼‰
ã€è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«ã€‘ï¼šï¼ˆèª­è€…ãŒã“ã®è¨˜äº‹ã§å¾—ã‚‰ã‚Œã‚‹ä¾¡å€¤ï¼‰
ã€è¦‹å‡ºã—æ§‹æˆæ¡ˆã€‘ï¼š
 - H2: ï¼ˆãƒ¡ã‚¤ãƒ³è¦‹å‡ºã—1ï¼‰
 - H2: ï¼ˆãƒ¡ã‚¤ãƒ³è¦‹å‡ºã—2ï¼‰
 - H2: ï¼ˆãƒ¡ã‚¤ãƒ³è¦‹å‡ºã—3ï¼‰
ã€SEOãƒã‚¤ãƒ³ãƒˆã€‘ï¼šï¼ˆæ¤œç´¢ä¸Šä½ã‚’ç‹™ã†ãŸã‚ã®ãƒã‚¤ãƒ³ãƒˆï¼‰
---

# åˆ†æžå¯¾è±¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆ{total_count}ä»¶ã‹ã‚‰æŠœç²‹ï¼‰
{formatted_keywords}""",

                "SEOè¨˜äº‹æ§‹æˆ": f"""SEOãƒ©ã‚¤ã‚¿ãƒ¼ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¾¤ã‹ã‚‰1ã¤ã®ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸ã³ã€æ¤œç´¢ä¸Šä½ã‚’ç‹™ãˆã‚‹è¨˜äº‹æ§‹æˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›å½¢å¼ã€‘
## é¸æŠžã—ãŸãƒ¡ã‚¤ãƒ³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
ï¼ˆé¸æŠžç†ç”±ã‚‚å«ã‚€ï¼‰

## è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ3æ¡ˆï¼‰
1. 
2. 
3. 

## æƒ³å®šèª­è€…ã¨ãƒ‹ãƒ¼ã‚º
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼š
- æ¤œç´¢æ„å›³ï¼š
- è§£æ±ºã—ãŸã„æ‚©ã¿ï¼š

## è¨˜äº‹æ§‹æˆ
### ãƒªãƒ¼ãƒ‰æ–‡ã®è¦ç´ 
- 
- 

### æœ¬æ–‡æ§‹æˆ
1. H2: 
   - H3: 
   - H3: 
2. H2: 
   - H3: 
   - H3: 
3. H2: 
   - H3: 

### ã¾ã¨ã‚
- 

## é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ´»ç”¨æˆ¦ç•¥
ï¼ˆã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã©ã®è¦‹å‡ºã—ã§ä½¿ã†ã‹ï¼‰

# å‚è€ƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
{formatted_keywords}""",

                "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¤ãƒ‡ã‚¢": f"""ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒžãƒ¼ã‚±ã‚¿ãƒ¼ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰å¤šæ§˜ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’10å€‹ææ¡ˆã—ã¦ãã ã•ã„ã€‚

å„ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ä»¥ä¸‹ã®å½¢å¼ã§ï¼š

ã€ã‚¢ã‚¤ãƒ‡ã‚¢{{ç•ªå·}}ã€‘
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ï¼šï¼ˆè¨˜äº‹/å‹•ç”»/ã‚¤ãƒ³ãƒ•ã‚©ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç­‰ï¼‰
- ã‚¿ã‚¤ãƒˆãƒ«ï¼š
- æ¦‚è¦ï¼šï¼ˆ50æ–‡å­—ç¨‹åº¦ï¼‰
- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼š
- é…ä¿¡ãƒãƒ£ãƒãƒ«ï¼š

# å‚è€ƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
{formatted_keywords}""",

                "ç«¶åˆåˆ†æž": f"""SEOã‚¢ãƒŠãƒªã‚¹ãƒˆã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç¾¤ã®ç«¶åˆåˆ†æžã‚’è¡Œã„ã€å¸‚å ´å‚å…¥æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

## åˆ†æžè¦³ç‚¹
1. ç«¶åˆã®å¼·ã•ï¼ˆäºˆæƒ³ï¼‰
2. æ¤œç´¢ãƒœãƒªãƒ¥ãƒ¼ãƒ å‚¾å‘
3. åŽç›ŠåŒ–ã®å¯èƒ½æ€§
4. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆ
5. å‚å…¥ã™ã¹ãã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å„ªå…ˆé †ä½

## æˆ¦ç•¥ææ¡ˆ
- çŸ­æœŸæˆ¦ç•¥ï¼ˆ3ãƒ¶æœˆä»¥å†…ï¼‰ï¼š
- ä¸­æœŸæˆ¦ç•¥ï¼ˆ6ãƒ¶æœˆä»¥å†…ï¼‰ï¼š
- é•·æœŸæˆ¦ç•¥ï¼ˆ1å¹´ä»¥å†…ï¼‰ï¼š

# åˆ†æžå¯¾è±¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
{formatted_keywords}"""
            }
            
            selected_prompt = prompts[prompt_type]
            
            st.text_area(
                f"ðŸ“‹ {prompt_type}ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦ChatGPTã§ä½¿ç”¨ï¼‰",
                selected_prompt,
                height=400,
                help="ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ChatGPTã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"
            )
    
    else:
        st.error("âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")

elif analyze_button and not keyword_input:
    st.warning("âš ï¸ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# ãƒ•ãƒƒã‚¿ãƒ¼
st.markdown("---")
col1, col2, col3 = st.columns(3)

with col1:
    st.markdown("**ðŸš€ SEO Keyword Tool Pro**")

with col2:
    st.markdown("Powered by Streamlit")

with col3:
    st.markdown(f"Last updated: {datetime.now().strftime('%Y-%m-%d %H:%M')}")

# æ³¨æ„äº‹é …
with st.expander("âš ï¸ åˆ©ç”¨ä¸Šã®æ³¨æ„"):
    st.markdown("""
    ### ðŸ’° å®Œå…¨ç„¡æ–™ç‰ˆ
    - **ã™ã¹ã¦ã®æ©Ÿèƒ½ãŒç„¡æ–™**ã§åˆ©ç”¨å¯èƒ½ã§ã™
    - å¤–éƒ¨ã®æœ‰æ–™APIã¯ä¸€åˆ‡ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“
    - Googleã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆç„¡æ–™ï¼‰ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½ã®ã¿ä½¿ç”¨
    
    ### ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ã¤ã„ã¦
    - Google Suggest APIã‚’åˆ©ç”¨ã—ã¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã„ã¾ã™
    - å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚ŠGoogleã‹ã‚‰ä¸€æ™‚çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
    - ãƒˆãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ã¯å­£ç¯€äºˆæ¸¬ + ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§pytrendsï¼ˆç„¡æ–™ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
    
    ### ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
    - å®Ÿéš›ã®Googleãƒˆãƒ¬ãƒ³ãƒ‰ã‚’ä½¿ã„ãŸã„å ´åˆï¼š`pip install pytrends`
    - ãªãã¦ã‚‚å…¨æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™
    
    ### åˆ©ç”¨è¦ç´„
    - æœ¬ãƒ„ãƒ¼ãƒ«ã¯æ•™è‚²ãƒ»ç ”ç©¶ç›®çš„ã§ã®åˆ©ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
    - å•†ç”¨åˆ©ç”¨æ™‚ã¯å„ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨è¦ç´„ã‚’ã”ç¢ºèªãã ã•ã„
    - é©åˆ‡ãªé–“éš”ã‚’ç©ºã‘ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™
    
    ### ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼
    - å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
    - ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™
    """)
